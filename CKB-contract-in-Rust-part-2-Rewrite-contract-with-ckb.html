<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JJy | Rust contract part 2 - Write contract with ckb-std</title>
  <link rel="stylesheet" href=" /css/main.css">
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  
  <!-- and it's easy to individually load additional languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  
  <script>hljs.highlightAll();</script>
</head>


<body>
  <header>
  <nav>
    <ul>
        <li><a href=" /">All</a></li>
        <li><a href=" /about">@JJy</a></li>
        <li><a href=" /atom.xml">RSS</a></li>
    </ul>
</nav>

</header>

  <main class="container">
    <article>
  <header>
    <h2>Rust contract part 2 - Write contract with ckb-std</h2>
    <time datetime=" 2020-01-06" class="post-meta">2020-01-06</time>
    <p>
      
      <a class="post-link" href=" tags/rust">Rust</a>
      
      <a class="post-link" href=" tags/ckb">CKB</a>
      
      <a class="post-link" href=" tags/english">English</a>
      
    </p>
  </header>
  <blockquote>
  <p>Edited at 2020-03-27</p>

  <ul>
    <li>Update <code class="language-plaintext highlighter-rouge">ckb-std</code> and <code class="language-plaintext highlighter-rouge">ckb-tool</code></li>
  </ul>
</blockquote>

<p>This article introduces the <code class="language-plaintext highlighter-rouge">ckb-std</code> library; and shows how to rewrite our minimal contract with <code class="language-plaintext highlighter-rouge">ckb-std</code>, to enables syscalls and <code class="language-plaintext highlighter-rouge">Vec</code>, <code class="language-plaintext highlighter-rouge">String</code>.</p>

<p>The previous contract:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![no_std]</span>
<span class="nd">#![no_main]</span>
<span class="nd">#![feature(asm)]</span>
<span class="nd">#![feature(lang_items)]</span>

<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">_start</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="cd">/// Exit syscall</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">exit</span><span class="p">(</span><span class="n">_code</span><span class="p">:</span> <span class="nb">i8</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="c1">// a0 is _code</span>
        <span class="nd">asm!</span><span class="p">(</span><span class="s">"li a7, 93"</span><span class="p">);</span>
        <span class="nd">asm!</span><span class="p">(</span><span class="s">"ecall"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">loop</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nd">#[panic_handler]</span>
<span class="k">fn</span> <span class="nf">panic_handler</span><span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nn">core</span><span class="p">::</span><span class="nn">panic</span><span class="p">::</span><span class="n">PanicInfo</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="k">loop</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nd">#[lang</span> <span class="nd">=</span> <span class="s">"eh_personality"</span><span class="nd">]</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">eh_personality</span><span class="p">()</span> <span class="p">{}</span>

<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">abort</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nd">panic!</span><span class="p">(</span><span class="s">"abort!"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="makefile">Makefile</h2>

<p>We compile and run tests again and again in the previous article, for convenient, let’s write a <code class="language-plaintext highlighter-rouge">Makefile</code> first:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span>: clean build patch
	cargo <span class="nb">test</span> <span class="nt">--</span> <span class="nt">--nocapture</span>

build:
	<span class="nb">cd </span>contract <span class="o">&amp;&amp;</span> cargo build

clean:
	<span class="nb">cd </span>contract <span class="o">&amp;&amp;</span> cargo clean

C :<span class="o">=</span> contract/target/riscv64imac-unknown-none-elf/debug/contract
patch:
	ckb-binary-patcher <span class="nt">-i</span> <span class="nv">$C</span> <span class="nt">-o</span> <span class="nv">$C</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">make test</code> is simple: rebuild the contract binary then run unit tests.</p>

<p>It is worth to notice the <code class="language-plaintext highlighter-rouge">patch</code> task, which calls <code class="language-plaintext highlighter-rouge">ckb-binary-patcher</code> to patch the contract binary; Its a solution for fixing VM’s buggy instructions, even we developed the CKB-VM diligently, there no bug-free software. Unfortunately, as the nature of blockchain, we can’t just fix the VM without a hard-fork. A better approach is to patch binary to get across the buggy instruction. You can see <a href="https://github.com/nervosnetwork/ckb-vm/issues/92">this issue</a> for details.</p>

<p>Installing the <code class="language-plaintext highlighter-rouge">ckb-binary-patcher</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo <span class="nb">install</span> <span class="nt">--git</span> https://github.com/xxuejie/ckb-binary-patcher.git
</code></pre></div></div>

<p>Then type <code class="language-plaintext highlighter-rouge">make test</code> to compile and test contract.</p>

<h2 id="hidden-complexity-under-macro">Hidden complexity under macro</h2>

<p>Now let’s get back to our contract, the code is little complicated for a “hello world”. Let’s slim it, we begin with wrapping <code class="language-plaintext highlighter-rouge">_start</code> function:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">_start</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
    <span class="nf">exit</span><span class="p">(</span><span class="nf">main</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="c1">// code...</span>
    <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can write code in the <code class="language-plaintext highlighter-rouge">main</code> function, that’s looking more comfortable, except the <code class="language-plaintext highlighter-rouge">_start</code> function is annoying; we can use a macro to hide the <code class="language-plaintext highlighter-rouge">_start</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[macro_export]</span>
<span class="nd">macro_rules!</span> <span class="n">entry</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$main:path</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
        <span class="nd">#[no_mangle]</span>
        <span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">_start</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="o">!</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">f</span><span class="p">:</span> <span class="k">fn</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="o">=</span> <span class="nv">$main</span><span class="p">;</span>
            <span class="nn">ckb_std</span><span class="p">::</span><span class="nn">syscalls</span><span class="p">::</span><span class="nf">exit</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">entry</code> macro defines the <code class="language-plaintext highlighter-rouge">_start</code> function which just calls main then exits the program with syscall <code class="language-plaintext highlighter-rouge">exit</code>; our contract code is below:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="c1">// code...</span>
    <span class="mi">0</span>
<span class="p">}</span>

<span class="nd">entry!</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
</code></pre></div></div>

<p>The Rust macro system is powerful, we can hidden other annoying functions and definitions under the macro; this is the basic idea of <code class="language-plaintext highlighter-rouge">ckb-std</code>; let’s refactor the contract with <code class="language-plaintext highlighter-rouge">ckb-std</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#![no_std]</span>
<span class="nd">#![no_main]</span>
<span class="nd">#![feature(lang_items)]</span>
<span class="nd">#![feature(alloc_error_handler)]</span>
<span class="nd">#![feature(panic_info_message)]</span>

<span class="k">use</span> <span class="nn">ckb_std</span><span class="p">::{</span><span class="n">entry</span><span class="p">,</span> <span class="n">default_alloc</span><span class="p">};</span>

<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="c1">// code...</span>
    <span class="mi">0</span>
<span class="p">}</span>

<span class="nd">entry!</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="c1">// define global allocator</span>
<span class="nd">default_alloc!</span><span class="p">();</span>
</code></pre></div></div>

<p>This code looks good enough for a “hello world” program. The <code class="language-plaintext highlighter-rouge">rustc</code> requires the definition of features in the file, so we still need to keep them, but we hide other functions include a well-implemented panic handler and a global allocator in macros.</p>

<h2 id="ckb-std">ckb std</h2>

<p>Let’s try using <code class="language-plaintext highlighter-rouge">Vec</code>, <code class="language-plaintext highlighter-rouge">String</code> from <a href="https://doc.rust-lang.org/stable/std/alloc/index.html">alloc</a> crate, and use the debug syscall to output under the test environment.</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/// features...</span>

<span class="k">use</span> <span class="nn">alloc</span><span class="p">::</span><span class="n">vec</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">ckb_std</span><span class="p">::{</span><span class="n">debug</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">default_alloc</span><span class="p">};</span>

<span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="nd">vec!</span><span class="p">[</span><span class="mi">0u8</span><span class="p">;</span> <span class="mi">42</span><span class="p">];</span>
    <span class="nd">debug!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span> <span class="n">v</span><span class="nf">.len</span><span class="p">());</span>
    <span class="mi">0</span>
<span class="p">}</span>

<span class="nd">entry!</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="nd">default_alloc!</span><span class="p">();</span>

<span class="c1">// We can see the debug output under test environment.</span>
<span class="c1">// -&gt;</span>
<span class="c1">// 0x423f33c96845ca512f4c9e9b19015481a4a8db1cf56dd1ddff8cecc17c38ac5d [contract debug] 42</span>
</code></pre></div></div>

<p>References:</p>

<ul>
  <li><a href="https://github.com/jjyr/ckb-rust-demo/tree/part2">ckb-rust-demo</a></li>
  <li><a href="https://github.com/jjyr/ckb-std">ckb-std</a></li>
  <li><a href="https://doc.rust-lang.org/stable/std/alloc/index.html">alloc crate</a></li>
  <li><a href="https://github.com/xxuejie/ckb-binary-patcher">ckb-binary-patcher</a></li>
</ul>

</article>

  </main>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
      JJy
    </span>
    
    <span>© 2024</span>
  </a>
</footer>

</body>

</html>
