I"¼<h2 id="merkle-tree">Merkle Tree</h2>

<p>Merkle Tree æ˜¯åŒºå—é“¾ä¸­ç»å¸¸ï¼ˆæˆ–è€…è¯´å¿…é¡»ï¼Ÿï¼‰ä¼šç”¨åˆ°ç»“æ„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ¯”ç‰¹å¸äº¤æ˜“åˆ—è¡¨çš„ Merkle Tree

            A
          /   <span class="se">\</span>
        B       C
       / <span class="se">\ </span>    / <span class="se">\</span>
      D   E   F   G
     / <span class="se">\ </span>/ <span class="se">\ </span>/ <span class="se">\ </span>/ <span class="se">\</span>
     1 2 3 4 5 6 7 8
</code></pre></div></div>

<p>æ ‘çš„å¶å­èŠ‚ç‚¹ï¼ˆå›¾ä¸­çš„ <code class="highlighter-rouge">1,2,3,4,5,6,7,8</code>ï¼‰æ˜¯æ’å…¥çš„å…ƒç´ ï¼Œåœ¨å›¾ä¾‹ä¸­æ˜¯æ¯”ç‰¹å¸çš„ txidã€‚
éå¶å­èŠ‚ç‚¹æ˜¯å¯¹å·¦å³å­èŠ‚ç‚¹çš„ hash æ‘˜è¦å¦‚ <code class="highlighter-rouge">D = hash(1, 2)</code>, <code class="highlighter-rouge">B = hash(D, E)</code>ã€‚</p>

<p>æ ‘çš„æ ¹å³ root hash (ä¹Ÿå« merkle root) æ˜¯å¯¹æ•´æ£µæ ‘çš„æ‘˜è¦ã€‚</p>

<p>Merkle Tree ä½¿ç”¨åŠ å¯†å­¦ hash æ–¹æ³•ä¿è¯å®‰å…¨æ€§ï¼Œåªæœ‰ä»¥åŒæ ·é¡ºåºæ’å…¥åŒæ ·çš„å¶å­èŠ‚ç‚¹æ‰å¯ä»¥ç®—å‡ºä¸€è‡´çš„ root hashã€‚ç°åœ¨å¸¸ç”¨çš„ 256 ä½ hash ç¢°æ’çš„å‡ ç‡ä¸º <code class="highlighter-rouge">1 / 2 ** 256</code>ï¼Œå‡ ä¹ä¸ä¼šåœ¨ç°å®ä¸­å‘ç”Ÿ<a href="https://www.bilibili.com/video/av12467314">ç¢°æ’</a>ã€‚</p>

<p>Bitcoin åœ¨åŒºå—å¤´ä¿å­˜äº†äº¤æ˜“åˆ—è¡¨çš„ merkle rootï¼ŒèŠ‚ç‚¹åŒæ­¥äº¤æ˜“åˆ—è¡¨æ—¶é€šè¿‡è®¡ç®— merkle root å¹¶ä¸å—å¤´çš„ <code class="highlighter-rouge">hashMerkleRoot</code> å¯¹æ¯”æ¥ç¡®è®¤äº¤æ˜“åˆ—è¡¨æ˜¯å¦æ­£ç¡®ã€‚</p>

<p>Merkle tree çš„å¦ä¸€ä¸ªç‰¹æ€§ï¼Œæ˜¯å¯ä»¥è¯æ˜æŸä¸ªå…ƒç´ æ˜¯å¦æ˜¯ merkle tree çš„æˆå‘˜ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ¯”ç‰¹å¸äº¤æ˜“åˆ—è¡¨çš„ Merkle Tree

             A
           /   <span class="se">\</span>
         B       C.
       /  <span class="se">\ </span>     / <span class="se">\</span>
      D.    E   F    G
     / <span class="se">\ </span> /  <span class="se">\ </span>/ <span class="se">\ </span> / <span class="se">\</span>
     1 2 <span class="o">(</span>3<span class="o">)</span> 4. 5 6 7 8
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°ï¼Œä»…ç”¨å›¾ä¸­æ ‡è¯† <code class="highlighter-rouge">.</code> çš„èŠ‚ç‚¹å°±å¯ä»¥è®¡ç®—å‡º merkle rootï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä» tx3 åˆ° merkle root ä¹‹é—´çš„ä¸­é—´èŠ‚ç‚¹ <code class="highlighter-rouge">E = hash(tx3, tx4)</code>ï¼Œ<code class="highlighter-rouge">B = hash(D, E)</code>ï¼Œ<code class="highlighter-rouge">A = hash(B, C)</code>ã€‚
è®¡ç®—è¿‡ç¨‹æ°å¥½æ˜¯å¶å­èŠ‚ç‚¹ <code class="highlighter-rouge">tx3</code> åˆ° merkle root <code class="highlighter-rouge">A</code> çš„è·¯å¾„ <code class="highlighter-rouge">tx3 -&gt; E -&gt; B -&gt; A</code>ï¼Œæ‰€ä»¥ä¹Ÿå«åš merkle pathã€‚</p>

<p>åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬å¯ä»¥å‘åªæœ‰ <code class="highlighter-rouge">merkle root</code> çš„äººè¯æ˜ <code class="highlighter-rouge">tx3</code> æ˜¯è¿™ä¸ª merkle tree çš„æˆå‘˜ã€‚
è¯æ®å°±æ˜¯ <code class="highlighter-rouge">tx4, D, C</code>ï¼Œè¿™æ˜¯ <code class="highlighter-rouge">tx3</code> çš„ merkle proofã€‚</p>

<p>Merkle proof å¤§å°æ˜¯ <code class="highlighter-rouge">æ ‘é«˜åº¦ - 1</code>, å¶å­èŠ‚ç‚¹æ•°é‡ä¸º <code class="highlighter-rouge">n</code> æ—¶ï¼Œmerkle proof ä¸­ hash æ•°é‡ä¸º <code class="highlighter-rouge">log(n)</code>ï¼Œ</p>

<p>Bitcoin è½»èŠ‚ç‚¹çš„ SPV å°±æ˜¯ä¾èµ– merkle proofï¼Œä¸éœ€è¦å‘é€å®Œæ•´äº¤æ˜“åˆ—è¡¨ï¼Œåªéœ€å‘é€ <code class="highlighter-rouge">log(txs_count)</code> ä¸ª hash å°±å¯ä»¥è¯æ˜å—ä¸­åŒ…å«æŸä¸ªäº¤æ˜“ã€‚</p>

<p>å…¨èŠ‚ç‚¹ç”Ÿæˆ Merkle è¯æ˜ç®—æ³•å¦‚ä¸‹:</p>

<ol>
  <li>ä»æ ‘ä¸­éœ€è¦è¯æ˜çš„èŠ‚ç‚¹èŠ‚ç‚¹å¼€å§‹</li>
  <li>æ‰¾åˆ°å…„å¼ŸèŠ‚ç‚¹å°†å…¶åŠ å…¥ proof</li>
  <li>è·³è½¬åˆ°çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœæŠµè¾¾ root èŠ‚ç‚¹åˆ™åœæ­¢ï¼Œå¦åˆ™å›åˆ°ç¬¬ 2 æ­¥</li>
</ol>

<h2 id="merkle-mountain-range">Merkle Mountain Range</h2>

<p>Merkle Mountain Range (ç®€ç§° MMR) æ˜¯ Peter Todd æå‡ºçš„ä¸€ç§ Merkle Treeï¼Œè¢« Open timestamp å’Œ Grin ç­‰é¡¹ç›®ä½¿ç”¨ï¼Œè½»èŠ‚ç‚¹åè®® Fly client çš„è®ºæ–‡ä¸­ä¹Ÿä½¿ç”¨ MMR æ¥åš Merkle proofã€‚</p>

<p>MMR è¢«è®¾è®¡ä¸º append only, èŠ‚ç‚¹æ’å…¥åå°±ä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ”¯æŒåŠ¨æ€çš„æ’å…¥ã€‚</p>

<p>MMR å’Œæ¯”ç‰¹å¸çš„ Merkle tree ç›¸æ¯”ï¼Œæ›´é€‚åˆéœ€è¦åŠ¨æ€æ’å…¥çš„åœºæ™¯ã€‚</p>

<p>æ¯”å¦‚ Fly client åè®®çš„éœ€æ±‚ï¼Œå¯¹æ•´æ¡é“¾ä¸­çš„åŒºå—å¤´è®¡ç®— merkle root å¹¶æ”¾å…¥ä¸‹ä¸€ä¸ªåŒºå—å¤´ä¸­ã€‚å¦‚æœæ¯ä¸ªå—éƒ½é‡æ–°æ„é€ è¿™ä¹ˆåºå¤§çš„ merkle tree è®¡ç®—é‡ä¼šéå¸¸å¤§ï¼Œä½¿ç”¨ MMR å¯ä»¥åŠ¨æ€çš„æ’å…¥æ–°åŒºå—å¤´å¹¶è®¡ç®— root hashã€‚</p>

<p>è€Œæ¯”ç‰¹å¸ Merkle tree çš„åœºæ™¯æ˜¯é™æ€çš„ï¼Œåœ¨æ„é€ æ ‘å‰å°±å·²çŸ¥æ•´ä¸ªäº¤æ˜“åˆ—è¡¨ï¼Œä¸”åˆ—è¡¨ä¸ä¼šå˜åŒ–ã€‚</p>

<p>MMR çš„ç‰¹ç‚¹æ˜¯ append only, å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ’å…¥é¡ºåºä½œä¸ºèŠ‚ç‚¹çš„åæ ‡ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Height
3              14
             /    <span class="se">\</span>
            /      <span class="se">\</span>
           /        <span class="se">\</span>
          /          <span class="se">\</span>
2        6            13
       /   <span class="se">\ </span>       /    <span class="se">\</span>
1     2     5      9     12     17
     / <span class="se">\ </span>  / <span class="se">\ </span>   / <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\</span>
0   0   1 3   4  7   8 10  11 15  16 18
</code></pre></div></div>

<p>å¦‚å›¾æ‰€è¿°ï¼Œæ’å…¥äº† 11 ä¸ªå¶å­èŠ‚ç‚¹çš„ MMRï¼ŒèŠ‚ç‚¹æ•°å­—ä»£è¡¨æ’å…¥çš„é¡ºåºï¼ŒåŒæ—¶ä¹Ÿæ˜¯èŠ‚ç‚¹çš„åæ ‡ã€‚</p>

<p>å½“æ’å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œå¦‚æœå‡ºç°äº†åŒæ ·é«˜åº¦çš„æ ‘ï¼Œåˆ™éœ€è¦è¿›è¡Œåˆå¹¶ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Height
3              14
             /    <span class="se">\</span>
            /      <span class="se">\</span>
           /        <span class="se">\</span>
          /          <span class="se">\</span>
2        6            13           21
       /   <span class="se">\ </span>       /    <span class="se">\ </span>      /    <span class="se">\</span>
1     2     5      9     12     17     20
     / <span class="se">\ </span>  / <span class="se">\ </span>   / <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\</span>
0   0   1 3   4  7   8 10  11 15  16 18  19
</code></pre></div></div>

<p>æ’å…¥ç¬¬ 12 ä¸ªå¶å­èŠ‚ç‚¹(èŠ‚ç‚¹ 19)ï¼Œå› ä¸º <code class="highlighter-rouge">18</code> å’Œ <code class="highlighter-rouge">19</code> é«˜åº¦ç›¸åŒï¼Œåˆå¹¶ä¸¤ä¸ªå¶å­å¾—åˆ° <code class="highlighter-rouge">20</code>, æ­¤æ—¶ <code class="highlighter-rouge">17</code> å’Œ <code class="highlighter-rouge">20</code> é«˜åº¦ç›¸åŒï¼Œåˆå¹¶å¾—åˆ° <code class="highlighter-rouge">21</code>ã€‚</p>

<p>å¯ä»¥æ³¨æ„åˆ°ï¼Œåˆå¹¶èŠ‚ç‚¹çš„æ¬¡æ•°å’Œæ ‘çš„é«˜åº¦æœ‰å…³ï¼Œæ ‘é«˜ä¸º <code class="highlighter-rouge">log(n)</code>, å¢åŠ å¶å­èŠ‚ç‚¹æ—¶æœ€å·®çš„æƒ…å†µä¸‹éœ€è¦æ’å…¥ <code class="highlighter-rouge">log(n) + 1</code> ä¸ªèŠ‚ç‚¹ã€‚</p>

<h3 id="mmr-add">MMR add</h3>

<p>ä»å›¾ä¸­å¯ä»¥è§‚å¯Ÿåˆ°</p>

<ul>
  <li>çˆ¶èŠ‚ç‚¹å’Œå·¦å­èŠ‚ç‚¹ offset ä¸º  <code class="highlighter-rouge">2 ** height</code></li>
  <li>å…„å¼ŸèŠ‚ç‚¹é—´çš„ offset ä¸º <code class="highlighter-rouge">2 ** (height + 1) - 1</code></li>
</ul>

<p>åˆ©ç”¨è¿™äº›ç‰¹æ€§å¯ä»¥è®¡ç®—å‡ºä»»æ„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹çš„åæ ‡ã€‚</p>

<p>MMR æ’å…¥æ“ä½œéœ€è¦åˆ¤æ–­æ˜¯å¦åˆå¹¶ï¼Œæœ‰ä¸¤ç§åšæ³•ï¼š
ä¸€æ˜¯åˆ¤æ–­èŠ‚ç‚¹é«˜åº¦å’Œå…„å¼ŸèŠ‚ç‚¹çš„é«˜åº¦æ˜¯å¦ç›¸åŒï¼Œé«˜åº¦ç›¸åŒåˆ™è¿›è¡Œåˆå¹¶ï¼›
äºŒæ˜¯è®¡ç®—ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„é«˜åº¦ï¼Œå¦‚æœé«˜äºå½“å‰èŠ‚ç‚¹åˆ™éœ€è¦åˆå¹¶ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä¸€ä¸ªç®€å•çš„åšæ³•:
# 1. å°è¯•æ‰¾å·¦ä¾§çš„å…„å¼ŸèŠ‚ç‚¹çš„é«˜åº¦
# 2. é«˜åº¦ä¸å½“å‰èŠ‚ç‚¹ç›¸åŒåˆ™åˆå¹¶
</span><span class="k">class</span> <span class="nc">MMR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hasher</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_height</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">need_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="n">left_sibling_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">sibling_offset</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_height</span><span class="p">[</span><span class="n">left_sibling_pos</span><span class="p">]</span> <span class="o">==</span> <span class="n">height</span>
</code></pre></div></div>

<p>è¿™ä¸ªç®—æ³•æ¯”è¾ƒç®€å•ç›´è§‚ï¼Œå¼Šç«¯æ˜¯ MMR å¿…é¡»ç»´æŠ¤ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜èŠ‚ç‚¹åæ ‡å’Œå¯¹åº”é«˜åº¦ã€‚</p>

<p>æˆ‘ä»¬æ³¨æ„èŠ‚ç‚¹çš„é«˜åº¦åªå’ŒèŠ‚ç‚¹åæ ‡æœ‰å…³ï¼Œèƒ½å¦é€šè¿‡èŠ‚ç‚¹åæ ‡æ¥è®¡ç®—å‡ºå¯¹åº”çš„é«˜åº¦ï¼Ÿ</p>

<p>è§‚å¯Ÿå›¾ä¸­æœ€å·¦ä¾§çš„æ ‘å¯ä»¥å‘ç°ä¸åŒé«˜åº¦çš„å­æ ‘åæ ‡éšå«äº†èŠ‚ç‚¹æ•°é‡ï¼Œæ¯”å¦‚ 6 ä¸ºæ ¹çš„å­æ ‘å…±æœ‰ (0 ~ 6) 7 ä¸ªèŠ‚ç‚¹ï¼Œ 14 ä¸ºæ ¹çš„æ ‘å…±æœ‰ (0 ~ 14) 15 ä¸ªèŠ‚ç‚¹ã€‚
å¦‚æœå°†åæ ‡å˜ä¸ºä» 1 å¼€å§‹, å­æ ‘æ ¹åæ ‡å°±æ°å¥½ç­‰äºèŠ‚ç‚¹æ•°ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Grin ä½¿ç”¨çš„ç®—æ³•ï¼Œä½¿ç”¨ 1 based äºŒè¿›åˆ¶æ¥è¡¨ç¤ºèŠ‚ç‚¹åæ ‡
Height

2        111
       /     <span class="se">\</span>
1     11     110       1010
     /  <span class="se">\ </span>   / <span class="se">\ </span>     /    <span class="se">\</span>
0   1   10 100 101  1000  1001  1011
</code></pre></div></div>

<p>æ¯æ¬¡é«˜åº¦ä¸Šå‡ï¼Œå·¦å­æ ‘è¦åˆå¹¶åŒæ · n èŠ‚ç‚¹çš„å³å­æ ‘å¹¶æ–°å¢ä¸€ä¸ªçˆ¶èŠ‚ç‚¹ï¼Œå®é™…ä¸Šç›¸å½“äºè®¡ç®— <code class="highlighter-rouge">(n &lt;&lt; 1) + 1</code>ã€‚
è¡¨ç°åœ¨äºŒè¿›åˆ¶åˆ™æ˜¯å›¾ä¸­æœ€å·¦ä¾§æ ¹åæ ‡ <code class="highlighter-rouge">1, 11, 111, 1111</code> è¿™æ ·çš„å½¢å¼, æ°å¥½æ˜¯é«˜åº¦åŠ ä¸€ã€‚</p>

<p>æˆ‘ä»¬ä»ä»»ä½•ä¸€ä¸ªåæ ‡å¼€å§‹(æ¯”å¦‚ 1010)ï¼Œå°†åæ ‡ä¸æ–­å‘å·¦è·³è½¬ï¼Œç›´åˆ°åæ ‡æ‰€æœ‰ bits ä¸º 1ï¼Œä»£è¡¨æˆ‘ä»¬åˆ°è¾¾äº†æœ€å·¦ä¾§èŠ‚ç‚¹ï¼Œå°±å¯ä»¥å¾—åˆ°é«˜åº¦ã€‚
å› ä¸ºåæ ‡ä» 1 å¼€å§‹ï¼Œå’ŒèŠ‚ç‚¹æ•°é‡ä¸€è‡´ï¼Œæˆ‘ä»¬å‘ç°å°†åæ ‡å‘å·¦è·³è½¬ï¼Œç›¸å½“äºå°†å·¦ä¾§çš„æ ‘æ•´ä¸ªåˆ é™¤ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Height

2        111
       /     <span class="se">\</span>
1     11     110       1010
     /  <span class="se">\ </span>   / <span class="se">\ </span>     /    <span class="se">\</span>
0   1   10 100 101  1000  1001  1011

// åˆ é™¤æ‰æ•´ä¸ªå·¦ä¾§æ ‘åï¼Œ1010 åæ ‡å˜æˆäº† 11

1     11
     /  <span class="se">\</span>
0   1   10 100
</code></pre></div></div>

<p>ä» <code class="highlighter-rouge">1010</code> åæ ‡å¼€å§‹ï¼Œå‡å»å·¦ä¾§æ ‘(å½“å‰åæ ‡æœ€é«˜æœ‰æ•ˆä½å‡ä¸€ <code class="highlighter-rouge">1000 - 1 =&gt; 111</code>), å¯ä»¥å‘å·¦è·³è½¬ <code class="highlighter-rouge">1010 - (1000 - 1) =&gt; 11</code>ï¼Œä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ç›´åˆ°å¾—åˆ°å…¨éƒ¨ bits ä¸º 1 çš„åæ ‡ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tree_pos_height</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># è½¬æ¢ä¸ºä» 1 å¼€å§‹çš„åæ ‡
</span>    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">all_ones</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">num</span>

    <span class="k">def</span> <span class="nf">jump_left</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">most_significant_bits</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">most_significant_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># loop until we jump to all ones position, which is tree height
</span>    <span class="k">while</span> <span class="ow">not</span> <span class="n">all_ones</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">jump_left</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="c1"># count all 1 bits
</span>    <span class="k">return</span> <span class="n">pos</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div></div>

<p>æœ‰äº† <code class="highlighter-rouge">tree_pos_height</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å†™å…¥å¦‚ä¸‹æ’å…¥æ–¹æ³•ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MMR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hasher</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span> <span class="o">=</span> <span class="n">hasher</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="s">"""
        Insert a new leaf
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="c1"># ä¿å­˜å¶å­èŠ‚ç‚¹çš„ hash
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span>
        <span class="c1"># åˆ¤æ–­æ˜¯å¦éœ€è¦åˆå¹¶èŠ‚ç‚¹
</span>        <span class="c1"># tree_pos_height æ ¹æ®èŠ‚ç‚¹åæ ‡è®¡ç®—èŠ‚ç‚¹æ‰€åœ¨é«˜åº¦
</span>        <span class="c1"># å¦‚æœä¸‹ä¸ªæ’å…¥èŠ‚ç‚¹é«˜åº¦å¤§äºå½“å‰é«˜åº¦ï¼Œä»£è¡¨éœ€è¦åˆå¹¶
</span>        <span class="k">while</span> <span class="n">tree_pos_height</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">:</span>
            <span class="c1"># åˆå¹¶çš„çˆ¶èŠ‚ç‚¹åæ ‡
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># å·¦å­æ ‘
</span>            <span class="n">left_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">height</span><span class="p">)</span>
            <span class="c1"># å³å­æ ‘
</span>            <span class="n">right_pos</span> <span class="o">=</span> <span class="n">left_pos</span> <span class="o">+</span> <span class="n">sibling_offset</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">()</span>
            <span class="c1"># åˆå¹¶ Hash
</span>            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="n">left_pos</span><span class="p">])</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="n">right_pos</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
            <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">pos</span>

<span class="c1"># get left or right sibling offset by height
</span><span class="k">def</span> <span class="nf">sibling_offset</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">height</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div></div>

<h3 id="mmr-get_root">MMR get_root</h3>

<p>MMR å¯èƒ½ä¼šå‡ºç°å¤šä¸ªâ€œå±±å³°â€ï¼Œè¦æŠŠå¤šä¸ªå±±å³°åˆå¹¶ä¸ºä¸€ä¸ª root hashï¼Œ
è¿™ä¸ªæ“ä½œè¢«ç§°ä¸º â€œæ‹±èµ·â€ï¼ˆBaggingï¼‰ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Height
3              14
             /    <span class="se">\</span>
            /      <span class="se">\</span>
           /        <span class="se">\</span>
          /          <span class="se">\</span>
2        6            13
       /   <span class="se">\ </span>       /    <span class="se">\</span>
1     2     5      9     12     17
     / <span class="se">\ </span>  / <span class="se">\ </span>   / <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\</span>
0   0   1 3   4  7   8 10  11 15  16 18
</code></pre></div></div>

<p>â€œæ‹±èµ·â€ æ“ä½œä»æœ€å³ä¾§å±±å³°ï¼Œä¾æ¬¡å‘å·¦åˆå¹¶ï¼Œç›´åˆ°åªå‰©ä¸‹ root hashã€‚</p>

<p>å¦‚å›¾ root hash ç­‰äº <code class="highlighter-rouge">hash(hash(Node(18), Node(17)), Node(14))</code></p>

<p>åªè¦èƒ½å¤Ÿæ‰¾åˆ°æ‰€æœ‰å±±å³°çš„åæ ‡, å†è¿›è¡Œ â€œæ‹±èµ·â€ å°±å¯ä»¥å¾—åˆ° root hashã€‚ å› ä¸º MMR ä¼šä¸æ–­åˆå¹¶å­æ ‘ï¼Œå·¦ä¾§çš„å±±å³°ä¸€å®šæ˜¯æ˜¯ä¸ªå°½å¯èƒ½å¤§çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œä¸”èŠ‚ç‚¹æ•°é‡ä¸º <code class="highlighter-rouge">1 &lt;&lt; height + 1</code>ã€‚</p>

<p>åœ¨ç¡®å®š MMR èŠ‚ç‚¹æ•°é‡ä¸º <code class="highlighter-rouge">mmr_size</code> çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­çš„å°è¯•å·¦ä¾§å±±å³°çš„é«˜åº¦ï¼Œè®¡ç®—å±±å³°çš„äºŒå‰æ ‘èŠ‚ç‚¹æ•°é‡ <code class="highlighter-rouge">1 &lt;&lt; height + 1</code> æ‰¾åˆ°å°äº <code class="highlighter-rouge">mmr_size</code> çš„æœ€å¤§çš„æ ‘ï¼Œæ­¤æ—¶çš„ height å°±æ˜¯å·¦ä¾§å±±å³°çš„é«˜åº¦ã€‚</p>

<p>ä½¿ç”¨ä¸Šä¸€èŠ‚çš„äºŒè¿›åˆ¶èŠ‚ç‚¹åæ ‡ï¼Œå¯ä»¥ä» height è½¬æ¢ä¸ºå±±å³°çš„åæ ‡ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">left_peak_height_pos</span><span class="p">(</span><span class="n">mmr_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">get_left_pos</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="s">"""
        å°†é«˜åº¦è½¬ä¸ºä» 1 å¼€å§‹çš„äºŒè¿›åˆ¶çš„èŠ‚ç‚¹åæ ‡: (1 &lt;&lt; height + 1) - 1
        å†å‡å» 1 å¾—åˆ°ä» 0 å¼€å§‹çš„åæ ‡
        """</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prev_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">get_left_pos</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
    <span class="c1"># æ¯æ¬¡å¢åŠ  height 1 å°è¯•è®¡ç®—åæ ‡
</span>    <span class="c1"># å¦‚æœåæ ‡è¶…å‡ºå½“å‰çš„ mmr_sizeï¼Œä»£è¡¨å‰ä¸€æ¬¡ç»“æœæ­£ç¡®
</span>    <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="n">mmr_size</span><span class="p">:</span>
        <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">get_left_pos</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prev_pos</span><span class="p">)</span>
</code></pre></div></div>

<p>è®¡ç®—å‡ºå·¦ä¾§å±±å³°åï¼Œé€šè¿‡ä»¥ä¸‹æ­¥éª¤å¯»æ‰¾ä¸‹ä¸€ä¸ªå±±å³°</p>

<ol>
  <li>ä»¥å·¦ä¾§å±±å³°ä¸ºå½“å‰åæ ‡</li>
  <li>è·³åˆ°å½“å‰åæ ‡çš„å³ä¾§å…„å¼Ÿ</li>
  <li>å†è·³åˆ°å·¦ä¾§å­èŠ‚ç‚¹ï¼Œå¦‚é«˜åº¦ä½äº 0 åˆ™ä»£è¡¨å±±å³°ä¸å­˜åœ¨</li>
  <li>å¦‚æœåæ ‡å°äº mmr size åˆ™è¯¥åæ ‡æ˜¯å±±å³°ï¼Œå¦åˆ™å›åˆ°ç¬¬ 3 æ­¥</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_peaks</span><span class="p">(</span><span class="n">mmr_size</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">def</span> <span class="nf">get_right_peak</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">mmr_size</span><span class="p">):</span>
        <span class="c1"># è·³åˆ°å…„å¼ŸèŠ‚ç‚¹
</span>        <span class="n">pos</span> <span class="o">+=</span> <span class="n">sibling_offset</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
        <span class="c1"># è·³åˆ°å·¦ä¾§å­èŠ‚ç‚¹
</span>        <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="n">mmr_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># no right peak exists
</span>                <span class="k">return</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">height</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>

    <span class="n">poss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">left_peak_height_pos</span><span class="p">(</span><span class="n">mmr_size</span><span class="p">)</span>
    <span class="n">poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="c1"># é«˜åº¦ä¸º 0 æ—¶ä»£è¡¨æ‰¾åˆ°äº†æ‰€æœ‰çš„å±±å³°
</span>    <span class="k">while</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">get_right_peak</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">mmr_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">poss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">poss</span>
</code></pre></div></div>

<p>æœ€åè¿›è¡Œ â€œæ‹±èµ·â€ å¾—åˆ° root hash</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MMR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_root</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
        <span class="c1"># æ‰€æœ‰å±±å³°åæ ‡
</span>        <span class="n">peaks</span> <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># åˆå¹¶
</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bag_rhs_peaks</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bag_rhs_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
        <span class="n">rhs_peak_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs_peak_hashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># åˆå¹¶å³å±±å³°å’Œå·¦å±±å³°
</span>            <span class="n">peak_r</span> <span class="o">=</span> <span class="n">rhs_peak_hashes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">peak_l</span> <span class="o">=</span> <span class="n">rhs_peak_hashes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">()</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">peak_r</span><span class="p">)</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">peak_l</span><span class="p">)</span>
            <span class="n">rhs_peak_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs_peak_hashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rhs_peak_hashes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<h3 id="mmr-gen_proof">MMR gen_proof</h3>

<p>MMR æ„é€  Merkle proof éå¸¸ç®€å•ï¼š</p>

<ol>
  <li>æ„é€ ä»å¶å­èŠ‚ç‚¹åˆ°å±±å³°çš„ merkle proof</li>
  <li>æ‹±èµ·å³ä¾§çš„å±±å³°ï¼Œå°†ç»“æœåŠ å…¥ proof</li>
  <li>å°†å·¦ä¾§çš„å±±å³°ä»å³åˆ°å·¦åŠ å…¥ proof</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Height
3              14
             /    <span class="se">\</span>
            /      <span class="se">\</span>
           /        <span class="se">\</span>
          /          <span class="se">\</span>
2        6            13           21
       /   <span class="se">\ </span>       /    <span class="se">\ </span>      /    <span class="se">\</span>
1     2     5      9     12     17     20     24
     / <span class="se">\ </span>  / <span class="se">\ </span>   / <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\ </span>  /  <span class="se">\</span>
0   0   1 3   4  7   8 10  11 15  16 18  19 22  23 25
</code></pre></div></div>

<p>ä¾‹å­ï¼šæ„é€ å¶å­èŠ‚ç‚¹ <code class="highlighter-rouge">15</code> çš„ Merkle proof</p>

<ol>
  <li>æ„é€  <code class="highlighter-rouge">15</code> åˆ°å±±å³°çš„ <code class="highlighter-rouge">21</code> Merkle proofï¼Œproof = <code class="highlighter-rouge">16, 20</code></li>
  <li>æ‹±èµ·å³ä¾§å±±å³°ï¼Œå³ä¾§åªæœ‰ <code class="highlighter-rouge">24</code> å’Œ <code class="highlighter-rouge">25</code>ï¼Œç»“æœä¸º <code class="highlighter-rouge">hash(25, 24)</code> åŠ å…¥ proofï¼Œproof = <code class="highlighter-rouge">16, 20, hash(25, 24)</code>ã€‚</li>
  <li>å°†å·¦ä¾§çš„å±±å³°ä»å³åˆ°å·¦çš„æ’å…¥ proofï¼Œå·¦ä¾§åªæœ‰ <code class="highlighter-rouge">14</code>ï¼Œæ‰€ä»¥æœ€ç»ˆçš„ proof ä¸º <code class="highlighter-rouge">16, 20, hash(25, 24), 14</code>ã€‚</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MMR</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">gen_proof</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">'MerkleProof'</span><span class="p">:</span>
        <span class="n">proof</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># æ„é€ å¶å­èŠ‚ç‚¹åˆ°å±±å³°çš„ Merkle proof
</span>        <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span><span class="p">:</span>
            <span class="n">pos_height</span> <span class="o">=</span> <span class="n">tree_pos_height</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">next_height</span> <span class="o">=</span> <span class="n">tree_pos_height</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_height</span> <span class="o">&gt;</span> <span class="n">pos_height</span><span class="p">:</span>
                <span class="c1"># get left child sib
</span>                <span class="n">sib</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">sibling_offset</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
                <span class="c1"># break if sib is out of mmr
</span>                <span class="k">if</span> <span class="n">sib</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">proof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="n">sib</span><span class="p">])</span>
                <span class="c1"># goto parent node
</span>                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get right child
</span>                <span class="n">sib</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">sibling_offset</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
                <span class="c1"># break if sib is out of mmr
</span>                <span class="k">if</span> <span class="n">sib</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">proof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_hash</span><span class="p">[</span><span class="n">sib</span><span class="p">])</span>
                <span class="c1"># goto parent node
</span>                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">height</span>
            <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">peak_pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># æ‹±èµ·å³ä¾§çš„å±±å³°
</span>        <span class="n">rhs_peak_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bag_rhs_peaks</span><span class="p">(</span><span class="n">peak_pos</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rhs_peak_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">proof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs_peak_hash</span><span class="p">)</span>
        <span class="c1"># ä»å³å‘å·¦æ’å…¥å·¦ä¾§çš„å±±å³°
</span>        <span class="n">proof</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lhs_peaks</span><span class="p">(</span><span class="n">peak_pos</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">MerkleProof</span><span class="p">(</span><span class="n">mmr_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">last_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">proof</span><span class="o">=</span><span class="n">proof</span><span class="p">,</span>
                           <span class="n">hasher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">)</span>
</code></pre></div></div>

<p>éªŒè¯ Merkle proof æ—¶æŒ‰ç…§åŒæ ·é¡ºåºè®¡ç®— Merkle Root å³å¯</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MerkleProof</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmr_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">proof</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
                 <span class="n">hasher</span><span class="p">):</span>
        <span class="s">"""
        MMR Merkle Proof
        åŒ…å« mmr_size å’Œ proof åˆ—è¡¨
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmr_size</span> <span class="o">=</span> <span class="n">mmr_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proof</span> <span class="o">=</span> <span class="n">proof</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span> <span class="o">=</span> <span class="n">hasher</span>

    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">elem</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="s">"""
        root - MMR root
        pos - éªŒè¯çš„å¶å­èŠ‚ç‚¹åæ ‡
        elem - éªŒè¯çš„å¶å­èŠ‚ç‚¹å†…å®¹
        """</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">get_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmr_size</span><span class="p">)</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="n">elem_hash</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">proof</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proof</span><span class="p">:</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hasher</span><span class="p">()</span>
            <span class="c1"># åˆ¤æ–­æ˜¯å¦è¿›å…¥éªŒè¯å±±å³°çš„é˜¶æ®µ
</span>            <span class="k">if</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">peaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem_hash</span><span class="p">)</span>
                    <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>
                    <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem_hash</span><span class="p">)</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">elem_hash</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
                <span class="k">continue</span>

            <span class="c1"># éªŒè¯å­æ ‘çš„ Merkle proof
</span>            <span class="n">pos_height</span> <span class="o">=</span> <span class="n">tree_pos_height</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">next_height</span> <span class="o">=</span> <span class="n">tree_pos_height</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># å¦‚æœä¸‹ä¸ªæ ‡ä½œé«˜åº¦æ›´é«˜ï¼Œè¯æ˜å½“å‰æ˜¯å³å­èŠ‚ç‚¹ï¼Œå¦åˆ™å½“å‰ä¸ºå·¦å­èŠ‚ç‚¹
</span>            <span class="k">if</span> <span class="n">next_height</span> <span class="o">&gt;</span> <span class="n">pos_height</span><span class="p">:</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem_hash</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">elem_hash</span><span class="p">)</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">proof</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">height</span>
            <span class="n">elem_hash</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
            <span class="n">height</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">elem_hash</span> <span class="o">==</span> <span class="n">root</span>
</code></pre></div></div>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p>Merkle Mountain Range çš„ç»“æ„å’Œåå­—ä¸€æ ·éå¸¸å®¹æ˜“ç†è§£ï¼Œä½†æƒ³è¦æ­£ç¡®çš„å®ç°åˆ™éœ€è¦æŒæ¡ä¸€äº› trick, æ–‡ä¸­ä½¿ç”¨çš„åæ ‡è®¡ç®—ç®—æ³•å¤§éƒ¨åˆ†æ˜¯å‚è€ƒè‡ª Grin çš„æ–‡æ¡£å’Œæºç ã€‚</p>

<p>Merkle proof åœ¨è½»èŠ‚ç‚¹åè®®ä¸­éå¸¸é‡è¦ï¼Œæˆ‘æœ€è¿‘åœ¨åš Nervos CKB è½»èŠ‚ç‚¹çš„ POC ç ”ç©¶ï¼Œåç»­ä¼šåœ¨åšå®¢é‡Œä»‹ç»æ›´å¤š Nervos CKB ç›¸å…³çš„æŠ€æœ¯ã€‚</p>

<ol>
  <li><a href="https://github.com/opentimestamps/opentimestamps-server/blob/master/doc/merkle-mountain-range.md">Merkle Mountain Range</a></li>
  <li><a href="https://github.com/mimblewimble/grin/blob/master/doc/mmr.md">Grin MMR æ–‡æ¡£</a></li>
  <li><a href="https://github.com/mimblewimble/grin/blob/0ff6763ee64e5a14e70ddd4642b99789a1648a32/core/src/core/pmmr.rs#L606">Grin æºç æ³¨é‡Š æ ¹æ®åæ ‡è®¡ç®—é«˜åº¦</a></li>
  <li><a href="https://github.com/jjyr/mmr.py">mmr.py å®Œæ•´çš„ MMR å®ç°</a></li>
  <li><a href="https://www.bilibili.com/video/av12467314">3Blue1Brown 256 ä½ç¢°æ’çš„æ¦‚ç‡</a></li>
</ol>

:ET