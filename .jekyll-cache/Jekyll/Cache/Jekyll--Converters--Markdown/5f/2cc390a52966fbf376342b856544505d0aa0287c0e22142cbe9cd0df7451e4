I"”<p>##ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ActiveSupport::Concern
<em>active_support/concern.rb</em>ä¸­å·²è§£é‡Šçš„å¾ˆæ¸…æ¥š
ç®€è¦çš„æ€»ç»“ä¸‹
â€”â€”â€”â€”â€”â€”â€”â€”
module Baréœ€è¦åœ¨includedæ—¶è°ƒç”¨module Fooçš„æ–¹æ³•</p>

<p>æ­¤æ—¶éœ€è¦åœ¨class Cä¸­include Barå°±éœ€è¦å…ˆinclude Foo</p>

<p>ä½†æ˜¯åƒè¿™æ ·ä½¿ç”¨çš„æ—¶å€™éœ€è¦å…³å¿ƒä¾èµ–é—®é¢˜æ˜¯å¾ˆä¸çˆ½çš„ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨Baråˆ™include Barå³å¯,ä¸åº”è¯¥å†å»ç®¡Barçš„ä¾èµ–é—®é¢˜</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Bar</span>
  <span class="kp">include</span> <span class="no">Foo</span>
  <span class="c1">#.....</span>
<span class="k">end</span>
</code></pre></div></div>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åªinclude Barè€Œä¸éœ€è¦å…³å¿ƒFoo</p>

<p>ä½†è¿™æ ·ä¹Ÿæœ‰é—®é¢˜,Fooå¯èƒ½åœ¨includedä¸­éœ€è¦class Cã€‚ä½†æ˜¯ç°åœ¨è¿™æ ·Fooåœ¨includedä¸­å–åˆ°çš„å®é™…æ˜¯Barï¼Œå¹¶ä¸æ˜¯C</p>

<p>ActiveSupport::Concernå¯ä»¥ç¥å¥‡çš„å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯Barçš„æ‰§è¡Œæ²¡é—®é¢˜,å¹¶ä¸”ä½¿ç”¨è€…ä¸éœ€è¦å…³å¿ƒFoo</p>

<p>åªéœ€æŠŠdef self.includedæ¢æˆConcernæä¾›çš„includeæ–¹æ³•å³å¯</p>

<h2 id="concernæºç ">Concernæºç </h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Concern</span>
    <span class="c1">#è¢«extendæ—¶ä¼šå¯¹extendå…¶çš„moduleè®¾ç½®ä¸€ä¸ªå®ä¾‹å˜é‡ç”¨äºå‚¨å­˜ä¾èµ–æ•°ç»„</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
      <span class="n">base</span><span class="p">.</span><span class="nf">instance_variable_set</span><span class="p">(</span><span class="s2">"@_dependencies"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">end</span>

    <span class="c1">#è¢«includeæ—¶ä¼šåœ¨includeå…¶çš„moduleä¸­è¿½åŠ ä¾èµ–self</span>
    <span class="c1">#å¦‚æœincludeçš„å¯¹è±¡ä¸­ä¸åŒ…å«@_dependencies(å³æ²¡æœ‰extend Concern)</span>
    <span class="c1">#åˆ™è¡¨æ˜è¯¥å¯¹è±¡ä¸ºæ­£ç¡®çš„includeç›®æ ‡,åœ¨è¯¥å¯¹è±¡ä¸Šincludeæ‰€æœ‰æœ¬moduleä¾èµ–çš„module,extend ClassMethodsã€‚æœ€åè°ƒç”¨'included'å¯ä»¥ä¿è¯é¿å…includedä¸­çš„ä¾èµ–é—®é¢˜</span>
    <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">base</span><span class="p">.</span><span class="nf">instance_variable_defined?</span><span class="p">(</span><span class="s2">"@_dependencies"</span><span class="p">)</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">instance_variable_get</span><span class="p">(</span><span class="s2">"@_dependencies"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
        <span class="k">return</span> <span class="kp">false</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
        <span class="vi">@_dependencies</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">super</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="s2">"ClassMethods"</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="s2">"ClassMethods"</span><span class="p">)</span>
        <span class="n">base</span><span class="p">.</span><span class="nf">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">"@_included_block"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="c1">#å¦‚æœbaseä¸ä¸ºnilåˆ™è®¤ä¸ºæ˜¯è°ƒç”¨superçš„included(ä¿è¯é€šå¸¸çš„é’©å­ä¹Ÿå¯ä½¿ç”¨)</span>
    <span class="c1">#å¦åˆ™å­˜ä¸‹blockå¾…çœŸæ­£çš„ç±»includeæ—¶å†è°ƒç”¨</span>
    <span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">base</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="vi">@_included_block</span> <span class="o">=</span> <span class="n">block</span>
      <span class="k">else</span>
        <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>
<p>å¤§è‡´å°±æ˜¯è¿™æ ·ã€‚ç”¨æ˜¯å¦extend Concernæ¥åˆ¤æ–­æ˜¯ç”¨äºincludeçš„moduleè¿˜æ˜¯çœŸæ­£éœ€è¦max-inçš„ç±»</p>
:ET